name: Convert OSM data to Geoparquet & Upload to Hugging face

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 0' # Run weekly on Sunday at 2 AM

env:
  DUCKDB_VERSION: '1.3.2'
  OHSOME_PLANET_VERSION: '1.1.0'
  OVERTURE_MAPS_VERSION: '2025-09-24.0'
  OHSOME_JAR_PATH: ohsome-planet-cli/target/ohsome-planet.jar

jobs:
  download-convert-and-upload:
    runs-on: ubuntu-latest

    steps:
      # Needed for ohsome-planet CLI tool to convert .osm.pbf -> .parquet
      - name: Checkout ohsome-planet repository instead of this repository
        uses: actions/checkout@v3
        with:
          repository: 'GIScience/ohsome-planet'
          submodules: true
          ref: ${{ env.OHSOME_PLANET_VERSION }}

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: Cache ohsome-planet JAR
        uses: actions/cache@v3
        id: jar-cache
        with:
          path: ${{ env.OHSOME_JAR_PATH }}
          key: ${{ runner.os }}-ohsome-planet-${{ env.OHSOME_PLANET_VERSION }}

      - name: Install ohsome-planet
        if: steps.jar-cache.outputs.cache-hit != 'true'
        run: |          
          ./mvnw clean package -DskipTests

      - name: Install DuckDB
        run: |
          wget https://github.com/duckdb/duckdb/releases/download/v${{ env.DUCKDB_VERSION }}/duckdb_cli-linux-amd64.zip
          unzip duckdb_cli-linux-amd64.zip
          chmod a+x ./duckdb
      
      - name: install rclone
        run: curl https://rclone.org/install.sh | sudo bash
      
      - name: Install Hugging Face CLI
        run: pip install huggingface_hub[cli]

      - name: Test Dependencies
        run: |
          hf version
          ./duckdb :memory: "SELECT 1"
          java -jar ohsome-planet-cli/target/ohsome-planet.jar --help
      
      - name: Cache countries.csv
        uses: actions/cache@v3
        id: country-geometries-cache
        with:
          path: countries.csv
          key: overture-countries-${{ env.OVERTURE_MAPS_VERSION }}
      
      - name: Download countries.csv from overturemaps
        if: steps.country-geometries-cache.outputs.cache-hit != 'true'
        run: | 
          ./duckdb -c "
              INSTALL httpfs; LOAD httpfs;
              INSTALL 'spatial'; LOAD 'spatial';
              COPY (
                  SELECT
                      country as id,
                      ST_AsText(geometry) as wkt
                  FROM read_parquet('s3://overturemaps-us-west-2/release/${{ env.OVERTURE_MAPS_VERSION }}/theme=divisions/type=division_area/*', filename=true, hive_partitioning=1)
                  WHERE subtype = 'country' AND class = 'land'
                  ORDER BY country
              ) TO 'countries.csv' (HEADER, DELIMITER ';')
          "
      
      - name: Process planet
        run: |
          rclone copy \
            --http-url https://download.openplanetdata.com :http:osm/planet/pbf/planet-latest.osm.pbf . \
            --multi-thread-cutoff 0 --multi-thread-streams 128 --multi-thread-chunk-size 512M \
            --transfers 1 --progress

          java -jar ${{ env.OHSOME_JAR_PATH }} contributions \
            --pbf=planet-latest.osm.pbf --parallel=$(nproc) \
            --output planet --country-file countries.csv

          ./duckdb -c "
              INSTALL 'spatial'; LOAD 'spatial';
              COPY (
                  SELECT
                      osm_type::ENUM ('node', 'way', 'relation') AS osm_type,
                      osm_edits
                      osm_last_edit,
                      osm_id,
                      user,
                      tags,
                      bbox,
                      UNNEST(
                          CASE countries
                          WHEN [] THEN ['XX'] -- UNKNOWN COUNTRY
                          ELSE countries
                          END
                      ) as country,
                      ST_GeomFromWKB(geometry) as geometry
                  FROM 'planet/contributions/latest/*.parquet'
                  ORDER BY bbox.xmin, bbox.ymin, bbox.xmax, bbox.ymax
              ) TO 'data' (
                  FORMAT PARQUET,
                  CODEC 'zstd',
                  COMPRESSION_LEVEL 20,
                  PARQUET_VERSION v2,
                  PARTITION_BY (country)
              );
          "

      - name: Upload to Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: hf upload --repo-type dataset open2roam/openstreetmaps ./data
      
